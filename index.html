<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fest Hub ‚Äî Festival Management & Showcase</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Icons + Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- html2canvas for saving modal as image -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root {
      --primary-500: #6366f1;
      --primary-600: #4f46e5;
      --secondary-500: #10b981;
      --neutral-50: #f9fafb;
      --neutral-100: #f3f4f6;
      --neutral-200: #e5e7eb;
      --neutral-300: #d1d5db;
      --neutral-600: #4b5563;
      --neutral-700: #374151;
      --neutral-800: #1f2937;
      --neutral-900: #111827;
      --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --primary-gradient: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
      --neutral-gradient: linear-gradient(135deg, var(--neutral-50) 0%, #e5e7eb 100%);
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    }
    html, body { height: 100%; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--neutral-gradient);
      color: var(--neutral-800);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }

    /* Page transitions */
    .pages-container {
      position: relative;
      padding-top: 80px;
      height: calc(100vh - 80px);
      overflow-y: auto;
    }
    .page {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      opacity: 0;
      transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 1.5rem 1rem 2.5rem;
    }
    .page.active {
      opacity: 1;
      position: relative;
    }
    .fade-in {
      animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* Header */
    .page-header {
      max-width: 1200px;
      margin: 0 auto 2rem;
      padding: 1.5rem;
      background: var(--primary-gradient);
      color: white;
      border-radius: 0 0 24px 24px;
      box-shadow: var(--shadow-xl);
      animation: slideDown 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    @keyframes slideDown {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .logo-img {
      max-height: 64px;
      border-radius: 12px;
      box-shadow: var(--shadow-md);
    }
    .fest-title {
      font-weight: 700;
      font-size: 1.5rem;
      margin-bottom: 0.25rem;
    }
    .fest-subtitle {
      opacity: 0.95;
      font-size: 1rem;
      font-weight: 400;
    }
    .header-badge {
      font-size: 0.875rem;
      color: rgba(255,255,255,0.8);
    }

    /* Home Page - Enhanced Hero */
    .home-hero {
      text-align: center;
      padding: 3rem 1rem;
      max-width: 700px;
      margin: 0 auto;
      position: relative;
    }
    .home-hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(99,102,241,0.1) 0%, transparent 70%);
      animation: float 6s ease-in-out infinite;
      z-index: -1;
    }
    @keyframes float {
      0%, 100% { transform: translateX(-50%) translateY(0px); }
      50% { transform: translateX(-50%) translateY(-20px); }
    }
    .home-hero h1 {
      font-size: 2.5rem;
      font-weight: 700;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 1rem;
    }
    .home-hero p {
      font-size: 1.125rem;
      line-height: 1.7;
      color: var(--neutral-600);
      margin-bottom: 1.5rem;
    }

    /* Schedule Page */
    .content {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 2rem;
      box-shadow: var(--shadow-lg);
      overflow-y: auto;
    }
    .schedule-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 2rem;
      justify-content: center;
      padding: 0 1rem;
    }
    .schedule-filters .btn {
      border-radius: 50px;
      padding: 0.75rem 1.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 2px solid var(--neutral-200);
      background: white;
      color: var(--neutral-700);
    }
    .schedule-filters .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .schedule-filters .btn.active {
      background: var(--primary-gradient);
      color: white;
      border-color: transparent;
      box-shadow: var(--shadow-lg);
      transform: scale(1.05);
    }
    .schedule-section {
      margin-bottom: 3rem;
      animation: slideInRight 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .date-header {
      background: var(--primary-gradient);
      color: white;
      border-radius: 16px;
      padding: 1.25rem 1.5rem;
      font-weight: 600;
      font-size: 1.125rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-md);
    }
    .stage-header {
      background: var(--success-gradient);
      color: white;
      border-radius: 12px 12px 0 0;
      padding: 1rem 1.5rem;
      font-weight: 600;
      font-size: 1rem;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .stage-header:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .programme-card {
      background: var(--neutral-gradient);
      border-radius: 0 0 16px 16px;
      box-shadow: var(--shadow-md);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
      margin-bottom: 1rem;
      cursor: pointer;
      position: relative;
    }
    .programme-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary-gradient);
    }
    .programme-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-xl);
    }
    .programme-card-header {
      padding: 1.25rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--neutral-200);
    }
    .programme-card-body {
      padding: 1.25rem 1.5rem;
    }
    .programme-time {
      font-weight: 600;
      color: var(--primary-500);
      font-size: 0.875rem;
      background: rgba(99,102,241,0.1);
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
    }
    .programme-icon {
      font-size: 1.5rem;
      margin-right: 1rem;
      flex-shrink: 0;
    }
    .programme-name {
      font-weight: 500;
      font-size: 1.125rem;
      margin: 0;
      flex: 1;
      color: var(--neutral-800);
    }
    .badge-cat {
      font-weight: 600;
      background: var(--primary-gradient);
      color: white;
      border-radius: 20px;
      padding: 0.375rem 0.75rem;
      font-size: 0.75rem;
      box-shadow: var(--shadow-sm);
    }

    /* Results Page */
    .cards {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }
    .search-bar {
      max-width: 600px;
      margin: 0 auto 2rem;
    }
    .search-bar input {
      border-radius: 50px;
      padding: 0.75rem 1.5rem;
      border: 2px solid var(--neutral-200);
      transition: all 0.3s ease;
      font-size: 1rem;
    }
    .search-bar input:focus {
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
      transform: translateY(-1px);
    }
    .result-card {
      background: white;
      border-radius: 20px;
      box-shadow: var(--shadow-md);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
      margin-bottom: 1.5rem;
    }
    .result-card:hover {
      transform: translateY(-6px);
      box-shadow: var(--shadow-xl);
    }
    .result-card-top {
      padding: 1.5rem;
      background: rgba(99,102,241,0.05);
      border-bottom: 1px solid var(--neutral-200);
    }
    .result-card-body {
      padding: 1.5rem;
    }
    .result-card-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--neutral-900);
    }
    .result-card-subtitle {
      color: var(--neutral-600);
      font-size: 0.875rem;
    }
    .result-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 1rem;
      border-top: 1px solid var(--neutral-200);
    }
    .result-number {
      color: var(--neutral-600);
      font-size: 0.875rem;
    }
    .btn-view {
      background: transparent;
      border: 2px solid var(--primary-500);
      color: var(--primary-500);
      border-radius: 50px;
      padding: 0.5rem 1rem;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
    }
    .btn-view:hover {
      background: rgba(99, 102, 241, 0.1);
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
      transform: scale(1.05);
    }

    /* Modal Enhancements */
    .modal-content {
      border-radius: 20px;
      box-shadow: var(--shadow-xl);
      border: none;
      overflow: hidden;
    }
    .modal-header {
      background: var(--primary-gradient);
      color: white;
      border: none;
      padding: 1.5rem;
    }
    .modal-title {
      font-weight: 700;
      font-size: 1.25rem;
    }
    .modal-body {
      padding: 2rem;
    }
    .results-table {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }
    .results-table th {
      background: var(--primary-gradient);
      color: white;
      font-weight: 600;
      border: none;
      padding: 1rem 0.75rem;
    }
    .results-table td {
      padding: 1rem 0.75rem;
      border-bottom: 1px solid var(--neutral-200);
    }
    .results-table tr:hover {
      background: var(--neutral-50);
    }

    /* Image Capture Template */
    #imageCaptureTemplate {
      display: none;
      width: 100%;
      max-width: 600px;
      height: auto;
      background: var(--primary-gradient);
      padding: 2rem;
      border-radius: 24px;
      margin: 20px auto;
      font-family: 'Inter', sans-serif;
      color: white;
      box-sizing: border-box;
      box-shadow: var(--shadow-xl);
    }
    .image-container { text-align: center; }
    .fest-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 1rem; }
    .programme-name { font-size: 2.25rem; font-weight: 700; margin-bottom: 0.5rem; }
    .result-number { font-size: 1rem; margin-bottom: 0.25rem; opacity: 0.9; }
    .detail-line { font-size: 1rem; margin-bottom: 0.25rem; opacity: 0.9; }
    .winners-container { margin-top: 1.5rem; }
    .winner-block { margin-bottom: 1rem; padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .winner-top { font-size: 1.125rem; margin-bottom: 0.25rem; }
    .student-name { font-size: 1.25rem; font-weight: 600; }
    .winner-bottom { font-size: 0.875rem; opacity: 0.8; padding-left: 1.5rem; }

    /* Top Navigation */
    .top-nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: white;
      border-bottom: 1px solid var(--neutral-200);
      padding: 0.75rem 0;
      z-index: 1000;
      box-shadow: var(--shadow-md);
      backdrop-filter: blur(10px);
      display: flex;
    }
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      padding: 0.75rem;
      border-radius: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: var(--neutral-600);
      text-decoration: none;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .nav-item:hover {
      color: var(--primary-500);
      transform: translateY(-2px);
    }
    .nav-item.active {
      background: var(--primary-gradient);
      color: white;
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }
    .nav-item i { font-size: 1.25rem; margin-bottom: 0.25rem; }

    /* Empty States */
    .empty-state {
      text-align: center;
      color: var(--neutral-600);
      padding: 4rem 1rem;
      animation: fadeInUp 0.6s ease-out;
    }
    .empty-state i {
      font-size: 5rem;
      opacity: 0.2;
      display: block;
      margin-bottom: 1.5rem;
    }
    .empty-state h5 { font-weight: 600; margin-bottom: 0.5rem; color: var(--neutral-700); }
    .empty-state p { font-size: 1rem; opacity: 0.8; }

    /* Skeleton Loaders */
    .skeleton {
      background: linear-gradient(90deg, var(--neutral-200) 25%, var(--neutral-300) 50%, var(--neutral-200) 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 8px;
    }
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .skeleton-card { height: 100px; margin-bottom: 1rem; }
    .skeleton-line { height: 16px; width: 80%; margin-bottom: 0.5rem; }
    .skeleton-circle { width: 40px; height: 40px; border-radius: 50%; margin-right: 1rem; }

    /* Responsive */
    @media (max-width: 767.99px) {
      .page { padding: 1rem 0.5rem 2.5rem; }
      .content { padding: 1.5rem 1rem; border-radius: 16px; }
      .home-hero h1 { font-size: 2rem; }
      .schedule-filters { justify-content: flex-start; overflow-x: auto; padding: 0 0.5rem 0.75rem; scrollbar-width: none; }
      .schedule-filters::-webkit-scrollbar { display: none; }
      .programme-card-header, .programme-card-body { padding-left: 1rem; padding-right: 1rem; }
      .result-card-top, .result-card-body { padding: 1rem; }
      .modal-body { padding: 1.5rem; }
    }
    @media (min-width: 768px) {
      .grid-cols { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
    }
    @media (min-width: 1024px) {
      .grid-cols { grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); }
      .page { padding: 2rem; }
    }

    /* Accessibility */
    .btn:focus, .nav-item:focus, input:focus { outline: 2px solid var(--primary-500); outline-offset: 2px; }
    [role="button"] { cursor: pointer; }
  </style>
</head>
<body>

  <!-- Top Navigation -->
  <nav class="top-nav" role="navigation" aria-label="Main navigation">
    <a href="#" class="nav-item active" onclick="switchTab('home'); return false;" aria-current="page">
      <i class="bi bi-house"></i>
      <span>Home</span>
    </a>
    <a href="#" class="nav-item" onclick="switchTab('schedule'); return false;">
      <i class="bi bi-calendar-event"></i>
      <span>Schedule</span>
    </a>
    <a href="#" class="nav-item" onclick="switchTab('results'); return false;">
      <i class="bi bi-trophy"></i>
      <span>Results</span>
    </a>
  </nav>

  <div class="pages-container">
    <!-- Home Page -->
    <section id="home" class="page active fade-in">
      <header class="page-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
          <div class="d-flex align-items-center gap-3">
            <img src="../Main/log.png" alt="Festival Logo" class="logo-img" loading="lazy">
            <div>
              <h1 class="fest-title mb-0" id="festNameHome">Fest Hub</h1>
              <p class="fest-subtitle mb-0">Ignite Creativity & Celebrate Excellence</p>
            </div>
          </div>
          <span class="header-badge">Home</span>
        </div>
      </header>
      <main class="home-hero">
        <h1>Discover the Magic of Fest Hub</h1>
        <p>Immerse yourself in a world of artistic expression, where music, dance, drama, and innovation converge. From breathtaking performances to inspiring workshops, our festival brings together talents from across the globe for an unforgettable celebration of creativity and community.</p>
        <p class="mt-4">Dive into the schedule to plan your adventure, explore live results, and join thousands in cheering for the stars of tomorrow.</p>
      </main>
    </section>

    <!-- Schedule Page -->
    <section id="schedule" class="page">
      <header class="page-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
          <div class="d-flex align-items-center gap-3">
            <img src="../Main/log.png" alt="Festival Logo" class="logo-img" loading="lazy">
            <div>
              <h1 class="fest-title mb-0" id="festNameSchedule">Fest Hub</h1>
              <p class="fest-subtitle mb-0">Your Festival Journey Awaits</p>
            </div>
          </div>
          <span class="header-badge">Schedule</span>
        </div>
      </header>
      <main class="content">
        <div class="schedule-filters" id="scheduleFilters" role="tablist">
          <!-- Filters injected here -->
        </div>
        <section id="scheduleContainer" aria-live="polite">
          <!-- Schedule sections rendered here -->
        </section>
        <div id="scheduleEmpty" class="empty-state" style="display: none;">
          <i class="bi bi-calendar-x"></i>
          <h5>No Programmes Scheduled</h5>
          <p>Check back soon for the latest updates on performances and events.</p>
        </div>
      </main>
    </section>

    <!-- Results Page -->
    <section id="results" class="page">
      <header class="page-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
          <div class="d-flex align-items-center gap-3">
            <img src="../Main/log.png" alt="Festival Logo" class="logo-img" loading="lazy">
            <div>
              <h1 class="fest-title mb-0">Fest Hub Results</h1>
              <p class="fest-subtitle mb-0">Celebrate Outstanding Achievements</p>
            </div>
          </div>
          <span class="header-badge">Live Results</span>
        </div>
      </header>
      <main class="cards">
        <section class="search-bar text-center">
          <input id="searchInput" class="form-control form-control-lg w-100" placeholder="Search programmes or categories..." aria-label="Search programmes" />
        </section>
        <section id="grid" class="grid-cols">
          <!-- Cards injected here -->
        </section>
        <div id="emptyNote" class="empty-state" style="display:none;">
          <i class="bi bi-trophy"></i>
          <h5>No Results Yet</h5>
          <p>Results will be announced soon. Stay tuned for the winners!</p>
        </div>
      </main>
    </section>
  </div>

  <!-- Results Modal -->
  <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <h2 class="modal-title" id="modalTitle">Category - Programme</h2>
            <p id="modalSubtitle" class="mb-0 opacity-75">Result # ‚Äî Date</p>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button id="saveImageBtn" class="btn btn-outline-light btn-sm" aria-label="Save podium as image">
              <i class="bi bi-camera"></i> Save Podium
            </button>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table results-table mb-0">
              <thead>
                <tr>
                  <th scope="col" style="width:80px;">Place</th>
                  <th scope="col">Student</th>
                  <th scope="col">Team</th>
                </tr>
              </thead>
              <tbody id="modalResultsBody">
                <!-- Rows inserted here -->
              </tbody>
            </table>
          </div>
          <small class="text-muted d-block text-center mt-3">Only podium places (1st, 2nd, 3rd) are displayed publicly.</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Image Capture Template -->
  <div id="imageCaptureTemplate">
    <div class="image-container">
      <h2 id="fest-title" class="fest-title">üèÜ Fest Hub Official Result üèÜ</h2>
      <h1 id="programme-name" class="programme-name">PROGRAMME NAME</h1>
      <p id="result-number" class="result-number">Result: #1</p>
      <p id="category-line" class="detail-line">Category: Category</p>
      <p id="programme-line" class="detail-line">Programme: Programme</p>
      <div id="winners-container" class="winners-container">
        <!-- Winners inserted here -->
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055;">
    <div id="publicToast" class="toast align-items-center text-white bg-success border-0 shadow-lg" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastBody"></div>
        <button type="button" class="btn-close btn-close-white me-2" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Firebase Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, query, where, onSnapshot, orderBy, getDoc, doc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC0eal8jWB6ksEpFCEYMRIOhzpAROwlXns",
      authDomain: "festhub-d7138.firebaseapp.com",
      projectId: "festhub-d7138",
      storageBucket: "festhub-d7138.firebasestorage.app",
      messagingSenderId: "396565568701",
      appId: "1:396565568701:web:c2c4001be99eef231a6bd4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DOM Elements
    const pages = document.querySelectorAll('.page');
    const navItems = document.querySelectorAll('.nav-item');
    const festNameElements = document.querySelectorAll('[id*="festName"]');
    const grid = document.getElementById('grid');
    const emptyNote = document.getElementById('emptyNote');
    const searchInput = document.getElementById('searchInput');
    const modalTitle = document.getElementById('modalTitle');
    const modalSubtitle = document.getElementById('modalSubtitle');
    const modalResultsBody = document.getElementById('modalResultsBody');
    const saveImageBtn = document.getElementById('saveImageBtn');
    const publicToast = document.getElementById('publicToast');
    const toastBody = document.getElementById('toastBody');
    const imageTemplate = document.getElementById('imageCaptureTemplate');
    const festTitleEl = document.getElementById('fest-title');
    const programmeNameEl = document.getElementById('programme-name');
    const resultNumberEl = document.getElementById('result-number');
    const categoryLineEl = document.getElementById('category-line');
    const programmeLineEl = document.getElementById('programme-line');
    const winnersContainerEl = document.getElementById('winners-container');
    const scheduleContainer = document.getElementById('scheduleContainer');
    const scheduleFilters = document.getElementById('scheduleFilters');
    const scheduleEmpty = document.getElementById('scheduleEmpty');

    let currentProgramme = null;
    let programmes = [];
    let students = [];
    let schedules = [];
    let festName = 'Fest Hub';
    let currentStageFilter = 'all';
    let unsubStudents = null;
    let unsubProgrammes = null;
    let unsubSchedules = null;

    // Icon Map
    const iconMap = {
      'Dance': 'üíÉ',
      'Music': 'üé§',
      'Drama': 'üé≠',
      'Art': 'üé®',
      'Workshop': 'üõ†Ô∏è',
      'General': '‚≠ê',
      'default': 'üìÖ'
    };
    function getIcon(category) {
      return iconMap[category] || iconMap['default'];
    }

    // Tab Switching
    window.switchTab = function(tab) {
      pages.forEach(p => p.classList.remove('active', 'fade-in'));
      const targetPage = document.getElementById(tab);
      targetPage.classList.add('active', 'fade-in');
      navItems.forEach((item, idx) => item.classList.toggle('active', ['home', 'schedule', 'results'].indexOf(tab) === idx));
      if (tab === 'results') renderGrid(programmes);
      if (tab === 'schedule') renderSchedules();
    };

    // Load Fest Name
    async function loadFestName() {
      try {
        const festDoc = await getDoc(doc(db, 'fest', 'festName'));
        if (festDoc.exists()) {
          festName = festDoc.data().nameFest || festName;
          festNameElements.forEach(el => el.textContent = festName);
        }
      } catch (err) {
        console.error('Error loading fest name:', err);
      }
    }

    // Load Students
    function loadStudents() {
      const q = query(collection(db, 'students'));
      return onSnapshot(q, (snap) => {
        students = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      }, (err) => console.error('Students load error:', err));
    }

    // Load Announced Programmes
    function loadAnnouncedProgrammes() {
      const q = query(collection(db, 'programmes'), where('announced', '==', true), orderBy('finalizedAt', 'asc'));
      return onSnapshot(q, (snap) => {
        programmes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        programmes.forEach((p, index) => p.resultNumber = index + 1);
        renderGrid(programmes);
      }, (err) => console.error('Programmes load error:', err));
    }

    // Load Schedules
    function loadSchedules() {
      const q = query(collection(db, 'schedules'), orderBy('date', 'asc'));
      return onSnapshot(q, (snap) => {
        schedules = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderSchedules();
      }, (err) => {
        console.error('Schedules load error:', err);
        scheduleEmpty.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i><h5>Error Loading</h5><p>Unable to fetch schedules. Please try again later.</p>';
        scheduleEmpty.style.display = 'block';
      });
    }

    // Render Results Grid with Skeletons
    function renderGrid(list) {
      const search = searchInput.value.trim().toLowerCase();
      const filtered = list.filter(p => 
        !search || p.name?.toLowerCase().includes(search) || p.category?.toLowerCase().includes(search)
      );
      if (programmes.length === 0) {
        showSkeletons('grid', 6);
        return;
      }
      if (!filtered.length) {
        grid.innerHTML = '';
        emptyNote.style.display = 'block';
        return;
      }
      emptyNote.style.display = 'none';
      grid.innerHTML = filtered.map(p => {
        const finalizedBadge = p.finalized ? '<span class="badge bg-success">Finalized</span>' : '';
        const subtitle = p.type ? `${p.type}${p.participantCount ? ` ‚Ä¢ Group of ${p.participantCount}` : ''}` : '';
        return `
          <div class="result-card col-12">
            <div class="result-card-top d-flex justify-content-between align-items-start">
              <div class="badge-cat">${escapeHtml(p.category || 'General')}</div>
              <div class="text-end">${finalizedBadge}</div>
            </div>
            <div class="result-card-body">
              <h3 class="result-card-title">${escapeHtml(p.name || 'Untitled Programme')}</h3>
              <p class="result-card-subtitle mb-3">${escapeHtml(subtitle)}</p>
              <div class="result-card-footer">
                <span class="result-number">Result #${p.resultNumber || '-'}</span>
                <button class="btn btn-view" onclick="openProgramme('${p.id}')" onkeydown="if(event.key==='Enter') openProgramme('${p.id}')" aria-label="View results for ${p.name}">View Podium</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Show Skeleton Loaders
    function showSkeletons(containerId, count = 3) {
      const container = document.getElementById(containerId);
      container.innerHTML = Array.from({ length: count }, () => `
        <div class="result-card col-12">
          <div class="result-card-top p-4">
            <div class="skeleton skeleton-line"></div>
          </div>
          <div class="result-card-body p-4">
            <div class="skeleton skeleton-line" style="width: 60%;"></div>
            <div class="skeleton skeleton-line" style="width: 40%; margin-top: 0.5rem;"></div>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div class="skeleton skeleton-line" style="width: 80px;"></div>
              <div class="skeleton" style="width: 100px; height: 40px;"></div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Escape HTML
    function escapeHtml(s = '') {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    // Open Programme Modal
    async function openProgramme(progId) {
      const progDocRef = doc(db, 'programmes', progId);
      const progSnap = await getDoc(progDocRef);
      if (!progSnap.exists()) return;
      const prog = { id: progSnap.id, ...progSnap.data() };
      if (!prog.resultNumber) {
        const idx = programmes.findIndex(x => x.id === prog.id);
        prog.resultNumber = idx >= 0 ? idx + 1 : '-';
      }
      currentProgramme = prog;
      modalTitle.textContent = `${prog.category || 'Category'} ‚Äî ${prog.name || 'Programme'}`;
      modalSubtitle.textContent = `Result #${prog.resultNumber || '-'} ‚Ä¢ ${prog.finalizedAt ? new Date(prog.finalizedAt.seconds * 1000 || prog.finalizedAt).toLocaleString() : 'TBD'}`;
      const md = prog.marksDetails || {};
      const podiumEntries = Object.entries(md)
        .map(([sid, details]) => ({ sid, details, place: Number(details.place) || null }))
        .filter(e => e.place && [1,2,3].includes(e.place))
        .sort((a, b) => a.place - b.place);
      const theadHtml = `
        <th scope="col" style="width:80px;">Place</th>
        <th scope="col">Student</th>
        <th scope="col">Team</th>
      `;
      document.querySelector('#resultModal .results-table thead tr').innerHTML = theadHtml;
      const rowsHtml = podiumEntries.map(e => {
        const st = students.find(s => s.id === e.sid) || {};
        const placeSuffix = e.place === 1 ? 'st' : e.place === 2 ? 'nd' : 'rd';
        return `
          <tr>
            <td><strong>${e.place}${placeSuffix}</strong></td>
            <td>${escapeHtml(st.name || 'Unknown')}</td>
            <td>${escapeHtml(st.team || '-')}</td>
          </tr>
        `;
      }).join('') || '<tr><td colspan="3" class="text-center text-muted py-4">No podium results available yet.</td></tr>';
      const winnersHtml = podiumEntries.map(e => {
        const medal = ['ü•á', 'ü•à', 'ü•â'][e.place - 1];
        const st = students.find(s => s.id === e.sid) || {};
        const placeText = `${e.place}${e.place === 1 ? 'st' : e.place === 2 ? 'nd' : 'rd'} Place`;
        return `
          <div class="winner-block">
            <div class="winner-top">${medal} ${placeText}</div>
            <div class="winner-bottom">${escapeHtml(st.name || 'Unknown')} <span style="opacity:0.8;">‚Ä¢ ${escapeHtml(st.team || 'Independent')}</span></div>
          </div>
        `;
      }).join('');
      currentProgramme.winnersHtml = winnersHtml;
      modalResultsBody.innerHTML = rowsHtml;
      const modal = new bootstrap.Modal(document.getElementById('resultModal'));
      modal.show();
    }
    window.openProgramme = openProgramme;

    // Save Image
    saveImageBtn.addEventListener('click', async () => {
      if (!currentProgramme?.winnersHtml) {
        showToast('Error', 'No podium data available.');
        return;
      }
      festTitleEl.textContent = `üèÜ ${festName} Official Result üèÜ`;
      programmeNameEl.textContent = currentProgramme.name || 'Programme';
      resultNumberEl.textContent = `Result: #${currentProgramme.resultNumber || '-'}`;
      categoryLineEl.textContent = `Category: ${currentProgramme.category || 'General'}`;
      programmeLineEl.textContent = `Programme: ${currentProgramme.name || 'Programme'}`;
      winnersContainerEl.innerHTML = currentProgramme.winnersHtml;
      const originalStyle = imageTemplate.style.cssText;
      imageTemplate.style.cssText = 'display: block; position: absolute; left: -9999px; top: 0;';
      try {
        const canvas = await html2canvas(imageTemplate, { scale: 2, useCORS: true, backgroundColor: null });
        const safeName = (currentProgramme.name || 'result').replace(/[^\w\s-]/g, '_').slice(0, 50);
        canvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${safeName}_podium.png`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          showToast('Success', 'Podium image saved!');
        }, 'image/png');
      } catch (err) {
        console.error('Image capture error:', err);
        showToast('Error', 'Failed to generate image.');
      } finally {
        imageTemplate.style.cssText = originalStyle;
      }
    });

    // Show Toast
    function showToast(title, message) {
      if (title) {
        toastBody.innerHTML = `<strong>${title}:</strong> ${message}`;
      } else {
        toastBody.innerHTML = message;
      }
      const toast = new bootstrap.Toast(publicToast);
      toast.show();
    }

    // Schedule Functions
    function groupSchedules(items) {
      return items.reduce((acc, item) => {
        if (!acc[item.date]) acc[item.date] = {};
        if (!acc[item.date][item.stage]) acc[item.date][item.stage] = [];
        acc[item.date][item.stage].push(item);
        return acc;
      }, {});
    }
    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }
    function renderSchedules() {
      if (schedules.length === 0) {
        showScheduleSkeletons();
        return;
      }
      let filteredSchedules = schedules.filter(s => currentStageFilter === 'all' || s.stage === currentStageFilter);
      if (!filteredSchedules.length) {
        scheduleContainer.innerHTML = '';
        scheduleEmpty.style.display = 'block';
        return;
      }
      scheduleEmpty.style.display = 'none';
      const grouped = groupSchedules(filteredSchedules);
      const sortedDates = Object.keys(grouped).sort();
      let html = '';
      sortedDates.forEach((date, dateIdx) => {
        const dateFormatted = formatDate(date);
        const stages = grouped[date];
        let stagesHtml = '';
        Object.keys(stages).sort().forEach((stage, stageIdx) => {
          const programmes = stages[stage].sort((a, b) => a.time.localeCompare(b.time));
          let progHtml = programmes.map((p, progIdx) => `
            <div class="programme-card" style="animation-delay: ${ (dateIdx * 0.2) + (stageIdx * 0.1) + (progIdx * 0.05) }s;" 
                 onclick="handleProgrammeClick('${escapeHtml(p.programmeName)}', '${escapeHtml(p.category)}', '${p.time}', '${escapeHtml(p.stage)}')" 
                 role="button" tabindex="0" onkeydown="if(event.key==='Enter') handleProgrammeClick('${escapeHtml(p.programmeName)}', '${escapeHtml(p.category)}', '${p.time}', '${escapeHtml(p.stage)}')" aria-label="View ${p.programmeName} at ${p.time}">
              <div class="programme-card-header">
                <div class="d-flex justify-content-between align-items-center w-100">
                  <span class="programme-time">${p.time}</span>
                  <span class="badge-cat">${escapeHtml(p.category)}</span>
                </div>
              </div>
              <div class="programme-card-body">
                <div class="d-flex align-items-center">
                  <span class="programme-icon" aria-hidden="true">${getIcon(p.category)}</span>
                  <h6 class="programme-name">${escapeHtml(p.programmeName)}</h6>
                </div>
              </div>
            </div>
          `).join('');
          stagesHtml += `<div class="programme-card"><div class="stage-header" onclick="filterStage('${escapeHtml(stage)}')" style="cursor: pointer; user-select: none;" role="button" tabindex="0" onkeydown="if(event.key==='Enter') filterStage('${escapeHtml(stage)}')" aria-label="Filter to ${stage} stage">${escapeHtml(stage)}</div>${progHtml}</div>`;
        });
        html += `<section class="schedule-section" style="animation-delay: ${dateIdx * 0.1}s;"><div class="date-header">${dateFormatted}</div>${stagesHtml}</section>`;
      });
      scheduleContainer.innerHTML = html;
      // Filters
      const uniqueStages = [...new Set(schedules.map(s => s.stage))].sort();
      let filtersHtml = `<button class="btn ${currentStageFilter === 'all' ? 'active' : ''}" onclick="filterStage('all')" role="tab" aria-selected="${currentStageFilter === 'all'}">All Stages</button>`;
      uniqueStages.forEach(stage => {
        filtersHtml += `<button class="btn ${currentStageFilter === stage ? 'active' : ''}" onclick="filterStage('${escapeHtml(stage)}')" role="tab" aria-selected="${currentStageFilter === stage}">${escapeHtml(stage)}</button>`;
      });
      scheduleFilters.innerHTML = filtersHtml;
    }
    function showScheduleSkeletons() {
      scheduleContainer.innerHTML = `
        <section class="schedule-section">
          <div class="date-header skeleton" style="height: 60px;"></div>
          <div class="programme-card">
            <div class="stage-header skeleton" style="height: 50px;"></div>
            ${Array.from({length: 3}, () => '<div class="skeleton-card skeleton"></div>').join('')}
          </div>
        </section>
      `;
    }
    window.filterStage = function(stage) {
      currentStageFilter = stage;
      renderSchedules();
    };

    // Handle Programme Click
    window.handleProgrammeClick = function(name, cat, time, stage) {
      toastBody.innerHTML = `<strong>${name}</strong><br><small>Time: ${time} | Stage: ${stage} | Category: ${cat}</small>`;
      const toast = new bootstrap.Toast(publicToast);
      toast.show();
      const matching = programmes.find(pr => pr.name === name && pr.category === cat);
      if (matching) {
        switchTab('results');
        setTimeout(() => openProgramme(matching.id), 400);
      }
    };

    // Event Listeners
    searchInput.addEventListener('input', () => renderGrid(programmes));

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await loadFestName();
      unsubStudents = loadStudents();
      unsubProgrammes = loadAnnouncedProgrammes();
      unsubSchedules = loadSchedules();
      showSkeletons('grid', 6);
      showScheduleSkeletons();
    });

    // Cleanup
    window.addEventListener('beforeunload', () => {
      [unsubStudents, unsubProgrammes, unsubSchedules].forEach(unsub => unsub?.());
    });
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
